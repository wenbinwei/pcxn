<!DOCTYPE html>
<html>
	<head>
		<title>Gene Set Coexpression Network</title>
		<script src="http://canvasxpress.org/js/canvasXpress.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/css/jquery.dataTables.css">
		<script type="text/javascript" language="javascript" src="/js/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" language="javascript" src="/js/jquery.dataTables.min.js"></script>
		<link href="/shared/bootstrap/css/bootstrap.min.css" rel="stylesheet" />		
		<link rel="stylesheet" type="text/css" href="/TableTools/css/dataTables.tableTools.css">
		<script type="text/javascript" language="javascript" src="/TableTools/js/dataTables.tableTools.js"></script>
		<link rel="stylesheet" type="text/css" href="/pcxn/pcxn.css">

		<script type="text/javascript">
			$(document).ready(function(){
                sizeCanvas()
				//$(".result").show();
				$(".result").hide();
				$(".display").hide();
				$(".waitmessage").hide();
			});
			var pCutOffValue = 0.05;
			var topNValue = 0;
			var form1Response;
			var geneSetsValue;
			var	corrCutOffValue = 0.05;
			var	geneSetCollectionValue;
			var upGenesetNames = [];
			var downGenesetNames = [];

            function makeCanvasFitBoxContainer(selector) {
                // Throw away the canvas element and make a new one.
                var selected = $(selector)[0]
                var box = $(selected).closest('.box')[0]
                var id = selected.id

                var $newCanvas = $("<canvas>")
                $newCanvas.attr('id', id)

                $(box).children('div').replaceWith($newCanvas)
                var newCanvas = $newCanvas[0]
                newCanvas.style.width = '100%'
                newCanvas.style.height = '100%'
                newCanvas.width = box.offsetWidth - 15
                console.log("fit", id, newCanvas.width)
                newCanvas.height = newCanvas.width
            }

            function sizeCanvas() {
                makeCanvasFitBoxContainer('#canvas1')
                makeCanvasFitBoxContainer('#canvas2')
            }

			function handleForm1Response(response) {				
				// Get unique geneset names
				form1Response = response;
				if (form1Response.length==0){
					alert("None of your gene set names match those in the current database. The database is still in development. Please contact W.Wei@sheffield.ac.uk to help the development of the database.");
					return;
				}
				
				var u = {}, outputGenesetNames = [];
				for(var i = 0; i < form1Response.length; ++i){
					if(!u.hasOwnProperty(form1Response[i][0])) {
						outputGenesetNames.push(form1Response[i][0]);
						u[form1Response[i][0]] = 1;
					}
					if(!u.hasOwnProperty(form1Response[i][1])) {
						outputGenesetNames.push(form1Response[i][1]);
						u[form1Response[i][1]] = 1;
					}
				}
				
				var inputGeneSetNames = [];
				inputGeneSetNames = geneSetsValue.split("\n");
				
				var alertMessage =  " not match those in the current database:\n";
				var upperCaseOutputGenesetNames = [];
				for (var j = 0; j < outputGenesetNames.length; ++j){
					upperCaseOutputGenesetNames[j] = outputGenesetNames[j].toUpperCase();
				}
				var numberOfUnMatchedinputGenesets = 0;
				for ( var i = 0; i < inputGeneSetNames.length; ++i){
					var upperCaseInputGeneSetName = inputGeneSetNames[i].trim().toUpperCase();
					if (upperCaseOutputGenesetNames.indexOf(upperCaseInputGeneSetName) < 0) {
						alertMessage = alertMessage + inputGeneSetNames[i] + "\n"; 
						numberOfUnMatchedinputGenesets++;
					}
				}
					
				if (numberOfUnMatchedinputGenesets > 0) {
					var do_does = "do";
					if (numberOfUnMatchedinputGenesets ==1) {do_does = "does";}					
					alertMessage = numberOfUnMatchedinputGenesets + " of your gene set names " + do_does + alertMessage;
					alertMessage = alertMessage + "The database is still in development."
					alertMessage = alertMessage + "\nPlease contact W.Wei@sheffield.ac.uk to help the development of the database."
					alert(alertMessage);
					return;
				}
				$(".result").show();
				//alert(form1Response[0]);
				//alert(form1Response[0][0]);
				outputGenesetNames.sort();
				//alert("The geneset names are:" + outputGenesetNames);
				var partialCorrelationMatrix = [];
				for(var i = 0; i < outputGenesetNames.length; ++i){
					partialCorrelationMatrix[i] = [];
					for (var j = 0; j < outputGenesetNames.length; ++j){
						partialCorrelationMatrix[i][j] = 0;
					}
				}
				
				for(var k = 0; k < form1Response.length; ++k){
					var indexA, indexB;
					for (var i = 0; i < outputGenesetNames.length; ++i){
						if(form1Response[k][0] == outputGenesetNames[i]) {
							indexA = i;
						}
						if(form1Response[k][1] == outputGenesetNames[i]) {
							indexB = i;
						}
					}
					partialCorrelationMatrix[indexA][indexB] = form1Response[k][2];
					partialCorrelationMatrix[indexB][indexA] = form1Response[k][2];
				}

                sizeCanvas()
				
				var cnv4=document.getElementById('canvas1');
				var ctx4=cnv4.getContext('2d');
				ctx4.clearRect(0, 0, canvas1.width, canvas1.height);
				var clusterMethod = $("#selectClusterMethod").val();
				//alert("Clustermethod: " + clusterMethod);				
				var cx4 = new CanvasXpress('canvas1',
					{
						"z": { "gs" : outputGenesetNames},
						"x": { "gs" : outputGenesetNames},
						"y": {
							"vars": outputGenesetNames,
							"smps": outputGenesetNames,
							"data": partialCorrelationMatrix
						}
					}, 
					{
							"graphType": "Heatmap",
							"linkage" : clusterMethod,
							"varLabelRotate": 0,
							"maxSmpStringLen" : 20,
							"maxVarStringLen": 20,
							"autoScaleFont" : false,
							"varLabelFontSize" : 14,
							"smpLabelFontSize" : 14,
							"minTextSize" : 12,
							"title": "",
							"disableMenu" : true,
							"disableToolbar" : true,
							"resizable" : false
					},
					{
						'click' : function(o, e, t) {
							var eventDataId = t.getEventDataId(e);
							var selctedGeneSetName = "";
							if (eventDataId[0] && eventDataId[0].match(/Smp/)) {
								var A = eventDataId[0].split("-");
                                var H = parseInt(A[1]);
								selctedGeneSetName = t.data.y.smps[H];
							} else if (eventDataId[0] && eventDataId[0].match(/Var/)) {
								var A = eventDataId[0].split("-");
                                var H = parseInt(A[1]);
								selctedGeneSetName = t.data.y.vars[H];
							} else {
							}
							document.getElementById("selctedLeafName").innerHTML = selctedGeneSetName;
							var htmlLink = "";
							if (geneSetCollectionValue.match(/MSigDB/)) {
								htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + selctedGeneSetName +".html";
							} else if (geneSetCollectionValue.match(/pathprint/)) {
								//if (selctedGeneSetName.match(/KEGG/)){
								//	var linkGeneSetName = selctedGeneSetName.replace("(KEGG)", "");
								//	linkGeneSetName = linkGeneSetName.trim();
								//	var myRegExp = /\s|\W/g;
								//	linkGeneSetName = linkGeneSetName.replace(myRegExp, "_");
								//	linkGeneSetName = linkGeneSetName.toUpperCase();
								//	linkGeneSetName = "KEGG_" + linkGeneSetName + "_PATHWAY";
								//	htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + linkGeneSetName +".html";
								//} else {
									htmlLink = "http://compbio.sph.harvard.edu/hidelab/pathprint/Pathprint.html";
								//}
							}
							document.getElementById("selctedLeafNameLink").innerHTML = htmlLink;
							document.getElementById("selctedLeafNameLink").href = htmlLink;
							updateTable2();
						}
					}
				);
				if (clusterMethod != "DoNotCluster") {
					cx4.clusterSamples();
					cx4.clusterVariables();
				}
				
				//network
				var nodes = [];
				
				for(var i = 0; i < outputGenesetNames.length; ++i){
                    var newNode
					if($("#upgenesets").val() && (upGenesetNames.indexOf(outputGenesetNames[i].toUpperCase()) >= 0) ) {
                        // Member of the up-regulated geneset
						newNode = {"id": outputGenesetNames[i], "color" : "rgb(200,200,200)", "shape" : "sphere"};
					} else if($("#downgenesets").val() && (downGenesetNames.indexOf(outputGenesetNames[i].toUpperCase()) >=0) ) {
                        // Member of the down-regulated geneset
						newNode = {"id": outputGenesetNames[i], "color" : "rgb(55,55,55)", "shape" : "sphere"};
					}
					else {
						newNode = {"id": outputGenesetNames[i], "color" : "rgb(100,100,100)", "shape" : "triangle"};
					}
					nodes.push(newNode)
				}
				
				var tableData = new Array();
				var edges = new Array();
				var edgeIndex = 0;
				for(var k = 0; k < form1Response.length; ++k){
					var partialCor = form1Response[k][2];
					var pValue = form1Response[k][3];
					if ( (Math.abs(partialCor) > corrCutOffValue) && (pValue < pCutOffValue) ) {
						tableData[edgeIndex] = form1Response[k];
						var lineWidth = Math.abs(10*partialCor) + 1;
						if (partialCor > 0) {
							edges[edgeIndex] = {"id1" : form1Response[k][0],
									"id2" : form1Response[k][1],
									"color" : "rgba(255,0,0, 0.3)",
									"type" : "line",
									"width" : lineWidth,
									"value": partialCor};
						} else {
							edges[edgeIndex] = {"id1" : form1Response[k][0],
									"id2" : form1Response[k][1],
									"color" : "rgba(0,0,255, 0.3)",
									"type" : "line",
									"width" : lineWidth,
									"value": partialCor};
						}
						edgeIndex++;
					}					
				}
				//console.log(nodes);
				//console.log(edges);
				
				$("#table1").show();
				var t = $('#table1').DataTable({
					destroy: true,
					"columnDefs": [
						{ className: "dt-body-left", "targets": [ 0 ] },
						{ className: "dt-body-left", "targets": [ 1 ] },
						{ className: "dt-body-right", "targets": [ 2 ] },
						{ className: "dt-body-right", "targets": [ 3 ] },
						{ className: "dt-body-right", "targets": [ 4 ] }
					],
					"dom": 'T<"clear">lfrtip',		
					"tableTools": {
						"sSwfPath": "/swf/copy_csv_xls_pdf.swf"
					}
				});
				t.clear();
				t.rows.add( tableData );
				t.draw();
				
				var cx2 = new CanvasXpress(
					"canvas2",
					{
						"nodes" : nodes,
						"edges" : edges
					},
					{	"backgroundGradient1Color": "rgb(255,255,255)",
						"backgroundGradient2Color": "rgb(255,255,255)",
						"gradient": true,
						"graphType": "Network",
						"nodeFontColor": "rgb(29,34,43)",
						"showAnimation": true,
						"disableMenu" : true,
						"disableToolbar" : true,
						"resizable" : false
					},
					{
						'click' : function(o, e, t) {
							var eventDataId = t.getEventDataId(e);
							var selctedGeneSetName = t.data.nodes[eventDataId].id;
							document.getElementById("selctedNodeName").innerHTML = selctedGeneSetName;
							var htmlLink = "";
							if (geneSetCollectionValue.match(/MSigDB/)) {
								htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + selctedGeneSetName +".html";
							} else if (geneSetCollectionValue.match(/pathprint/)) {
								htmlLink = "http://compbio.sph.harvard.edu/hidelab/pathprint/Pathprint.html";
							}
							document.getElementById("selctedNodeNameLink").innerHTML = htmlLink;
							document.getElementById("selctedNodeNameLink").href = htmlLink;
							updateTable3();
						}
					}
				);
				
				var cnv=document.getElementById('canvas3');
				var ctx = cnv.getContext('2d');
				var pict = new Image();				
				if( topNValue > 0) {
					pict.src = "/pcxn/pcxn-legend1.png";
				} else {
					pict.src = "/pcxn/pcxn-legend2.png";
				}
				pict.onload = function (){
					ctx.clearRect(0, 0, canvas3.width, canvas3.height);
					ctx.drawImage(pict, 10, 10, pict.width*1, pict.height*1);
				}
			}

			function send(){
				var upVal = $("#upgenesets").val();
				var downVal = $("#downgenesets").val();
				var newTopNValue = $("#inputTopN").val();
				var newPCutOffValue = $("#inputpValue").val();
				var newCorrCutOffValue = $("#inputCorrelation").val();
				var newGeneSetCollectionValue = $("#selectGeneSetCollection").val();
				var newGeneSetsValue;

                // JSP API gets confused with leading and traling blank lines.
                // So eliminate those, and at the same time convert to upper case.
                upGenesetNames = upVal.trim().toUpperCase().split("\n")
                downGenesetNames = downVal.trim().toUpperCase().split("\n")
                $('#upgenesets').val(upGenesetNames.join("\n"))
                $('#downgenesets').val(downGenesetNames.join("\n"))

				if (upGenesetNames.length == 0 && downGenesetNames.length == 0)
				{
					alert("Please enter a list of gene sets!");
					return;
				}

                newGeneSetsValue = upGenesetNames.concat(downGenesetNames).join("\n").trim()

				if (newGeneSetsValue!=geneSetsValue |newTopNValue != topNValue | newPCutOffValue != pCutOffValue | newCorrCutOffValue != corrCutOffValue | newGeneSetCollectionValue != geneSetCollectionValue) {
					//alert("You have changed parameters!")
					geneSetsValue = newGeneSetsValue;
					topNValue = newTopNValue;					
					pCutOffValue = newPCutOffValue;
					corrCutOffValue = newCorrCutOffValue;
					geneSetCollectionValue = newGeneSetCollectionValue;
					var parms = {genesets : geneSetsValue, topN : topNValue , pCutOff : pCutOffValue, corrCutOff : corrCutOffValue, geneSetCollection :geneSetCollectionValue};
					$.getJSON("/pcxn/getPartialCorrelation.jsp", parms).done(handleForm1Response);
				} else {
					//alert("You have not changed parameters!")
					handleForm1Response(form1Response);
				}
			};
			
			function updateTable2() {
				$('#table2').hide();
				$("#table2waiting").show();
				var geneSetNameValue = document.getElementById("selctedLeafName").innerHTML;
				var parms = {geneSetCollection : geneSetCollectionValue, geneSetName : geneSetNameValue};
				$.getJSON("/pcxn/getGeneSetMembers.jsp", parms).done(handleTable2Response);
			}
			
			function updateTable3() {
				$('#table3').hide();
				$("#table3waiting").show();
				var geneSetNameValue = document.getElementById("selctedNodeName").innerHTML;
				var parms = {geneSetCollection : geneSetCollectionValue, geneSetName : geneSetNameValue};
				$.getJSON("/pcxn/getGeneSetMembers.jsp", parms).done(handleTable3Response);
			}
			
			function handleTable2Response(response) {
				var tableData = response;
				var tableid = '#table2';
				updateGeneSetTable(tableid, tableData);
				$("#table2waiting").hide();
			}
			
			function handleTable3Response(response) {
				var tableData = response;
				var tableid = '#table3';
				updateGeneSetTable(tableid, tableData);
				$("#table3waiting").hide();
			}
			
			function updateGeneSetTable(tableid, tableData) {
				for(var k = 0; k < tableData.length; ++k){
					var entrezid = tableData[k][0];
					var htmlLink = "http://www.ncbi.nlm.nih.gov/gene/" + entrezid;
					var el = '<a target="_blank" href=' + htmlLink +">" + entrezid + "</a>";
					tableData[k][0] = el;				
				}
				var t = $(tableid).DataTable({
					destroy: true,
					"columnDefs": [
						{ className: "dt-body-right", "targets": [ 0 ] },
						{ className: "dt-body-left", "targets": [ 1 ] },
						{ className: "dt-body-right", "targets": [ 2 ] }
					],
					"dom": 'T<"clear">lfrtip',		
					"tableTools": {
						"sSwfPath": "/swf/copy_csv_xls_pdf.swf"
					}
				});
				t.clear();
				t.rows.add( tableData );
				t.draw();
			 	$(tableid).show();
			}
			
			function doneResizing() {
				//alert("I'm done resizing for the moment");
				handleForm1Response(form1Response);
			};
			
			var resizeTimer;
			$(window).resize(function() {
				clearTimeout(resizeTimer);
				resizeTimer = setTimeout(doneResizing, 100);
			});
		</script>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-12">
					<h1>Gene Set Coexpression Network</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-4">
					<form id="form1" class="well">
						<label for="upgenesets">Find partial correlation between up-regulated gene sets</label><br>
						<textarea rows="7" cols="50" id="upgenesets"></textarea><br>
						
						<label for="downgenesets">and down-regulated gene sets </label><br>
						<textarea rows="7" cols="50" id="downgenesets"></textarea><br>
						
						<label for="inputTopN">and top</label>
						<input type="text" id="inputTopN" value="0"/><label>correlated genes sets</label><br>
						
						<label for="inputCorrelation"> with absolute correlation coefficient greater than</label>
						<input type="text" id="inputCorrelation" value="0.05"/><br>
						
						<label for="inputpValue">and p-value less than</label><br>
						<input type="text" id="inputpValue" value="0.05"/><br>
						
						<label for="selectGeneSetCollection">The gene sets are from</label><br>
						<select id="selectGeneSetCollection" size="1">
							<option value="pathprint">Pathprint</option>
						    <option value="MSigDBC2CP" selected="selected">MSigDB C2 CP (Canonical pathways)</option>
						    <option value="MSigDBC5">MSigDB C5 (GO gene sets)</option>
						</select>
						<br>
						<label for="selectClusterMethod">Cluster gene sets using</label><br>
						<select id="selectClusterMethod" size="1">
							<option value="average">Average linkage</option>
						    <option value="complete" selected="selected">Complete linkage</option>
						    <option value="single">Single linkage</option>
							<option value="DoNotCluster">Do not cluster</option>
						</select> 
												
						<input type="reset" id="button2" value=" Reset "/>
						<input type="button" id="button1" value=" GO " onclick="javascript:send();"/>
					</form>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12">
                    <!-- The "box" class here is used to find the right DIV when resizing.
                         See sizeCanvas() -->
					<div class="col-sm-6 box">
						<h2 class="result">Partial Correlation Heatmap</h2>
                        <!-- This div gets replaced by sizeCanvas() -->
                        <div>
                            <canvas id="canvas1"></canvas>
                        </div>
					</div>
					<div class="col-sm-6 box">
						<h2 class="result">Partial Correlation Network</h2>
                        <div>
                            <canvas id="canvas2"></canvas>
                        </div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12">	
					<div class="col-sm-6">	
						<h2 class="result">Gene set (click on dendrogram to select)</h2>
						<h3 class="result">Name</h3>
						<p id="selctedLeafName" class="result"> </p>
						<h3 class="result">External links</h3>
						<a  class="result" id="selctedLeafNameLink" target="_blank" href=""></a>
						<h3 class="result">Members on HG-U133 Plus2 array</h3>
						<table id="table2" class="display" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th>GeneID</th>
									<th>Symbol</th>
									<th>Description</th>
								</tr>
							</thead>

							<tfoot>
								<tr>
									<th>GeneID</th>
									<th>Symbol</th>
									<th>Description</th>
								</tr>
							</tfoot>
						</table>
						<p id="table2waiting" class="waitmessage">Please wait. Getting data ....</p>
					</div>
					<div class="col-sm-6">
						<canvas id="canvas3" class="result" width="450" height="300"></canvas>
						<h2 class="result">Gene set (click on a node to select)</h2>
						<h3 class="result">Name</h3>
						<p id="selctedNodeName" class="result"> </p>
						<h3 class="result">External links</h3>
						<a  class="result" id="selctedNodeNameLink" target="_blank" href=""></a>
						<h3 class="result">Members on HG-U133 Plus2 array</h3>
						<table id="table3" class="display" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th>GeneID</th>
									<th>Symbol</th>
									<th>Description</th>
								</tr>
							</thead>
							<tfoot>
								<tr>
									<th>GeneID</th>
									<th>Symbol</th>
									<th>Description</th>
								</tr>
							</tfoot>
						</table>
						<p id="table3waiting" class="waitmessage">Please wait. Getting data ....</p>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<div class="col-sm-12">
						<h2 class="result">Partial Correlation Table</h2>
						<div class="col-sm-12">
							<table id="table1" class="display" cellspacing="0" width="100%">
								<thead>
									<tr>
										<th>Gene Set A</th>
										<th>Gene Set B</th>
										<th>Partial Correlation</th>
										<th>p Value</th>
										<th>Overlap Coefficient</th>
									</tr>
								</thead>

								<tfoot>
									<tr>
										<th>Gene Set A</th>
										<th>Gene Set B</th>
										<th>Partial Correlation</th>
										<th>p Value</th>
										<th>Overlap Coefficient</th>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
