<!DOCTYPE html>
<html>
	<head>
		<title>Gene Set Coexpression Network</title>
		<script src="http://canvasxpress.org/js/canvasXpress.min.js"></script>
		<link rel="stylesheet" type="text/css" href="/css/jquery.dataTables.css">
		<script type="text/javascript" language="javascript" src="/js/jquery-2.1.1.min.js"></script>
		<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
		<script type="text/javascript" language="javascript" src="/js/jquery.dataTables.min.js"></script>
		<link href="/shared/bootstrap/css/bootstrap.min.css" rel="stylesheet" />		
		<link rel="stylesheet" type="text/css" href="/TableTools/css/dataTables.tableTools.css">
		<script type="text/javascript" language="javascript" src="/TableTools/js/dataTables.tableTools.js"></script>
		<link rel="stylesheet" type="text/css" href="/pcxn/pcxn.css">

		<script type="text/javascript">
			$(document).ready(function(){
                sizeCanvas()
				$("#form1").hide();
				$("#divResult").find('*').hide();
    			var parms = {geneSetCollection :"all"};
				$.getJSON("/pcxn/getAvailableGeneSets.jsp", parms).done(handleAvailableGeneSetsResponse);
			});
			var pCutOffValue = 0.05;
			var topNValue = 0;
			var form1Response;
			var geneSetsValue;
			var	corrCutOffValue = 0.05;
			var	geneSetCollectionValue;
			var upGenesetNames = [];
			var downGenesetNames = [];
			var pathprintGeneSets = [];
			var mSigDBC2CPGeneSets = [];
			var mSigDBC5GeneSets = [];
			var maxCorrInResponse = 0;
			var minPValueInResponse = 1;

            function makeCanvasFitBoxContainer(selector) {
                // Throw away the canvas element and make a new one.
                var selected = $(selector)[0]
                var box = $(selected).closest('.box')[0]
                var id = selected.id

                var $newCanvas = $("<canvas>")
                $newCanvas.attr('id', id)

                $(box).children('div').replaceWith($newCanvas)
                var newCanvas = $newCanvas[0]
                newCanvas.style.width = '100%'
                newCanvas.style.height = '100%'
                newCanvas.width = box.offsetWidth - 15
                console.log("fit", id, newCanvas.width)
                newCanvas.height = newCanvas.width
            }

            function sizeCanvas() {
                makeCanvasFitBoxContainer('#canvas1')
                makeCanvasFitBoxContainer('#canvas2')
            }

			function handleAvailableGeneSetsResponse (response) {
				pathprintGeneSets = response.pathprint;
				mSigDBC2CPGeneSets = response.MSigDBC2CP;
				mSigDBC5GeneSets = response.MSigDBC5;
				
				var availableGenesets = pathprintGeneSets.concat(mSigDBC2CPGeneSets);
				availableGenesets = availableGenesets.concat(mSigDBC5GeneSets);
				//alert(availableGenesets.length);
				$( "#textfieldGeneSet" ).autocomplete({
      				source: availableGenesets
    			});
    			
    			pathprintGeneSets = pathprintGeneSets.sort();
    			for(var i = 0; i < pathprintGeneSets.length; ++i){
					$('#selectPathprint')
         				.append($("<option></option>")
         				.attr("value",pathprintGeneSets[i])
         				.text(pathprintGeneSets[i])); 
				}
				
				mSigDBC2CPGeneSets = mSigDBC2CPGeneSets.sort();
    			for(var i = 0; i < mSigDBC2CPGeneSets.length; ++i){
					$('#selectMSigDBC2CP')
         				.append($("<option></option>")
         				.attr("value",mSigDBC2CPGeneSets[i])
         				.text(mSigDBC2CPGeneSets[i])); 
				} 
				
				mSigDBC5GeneSets = mSigDBC5GeneSets.sort();
    			for(var i = 0; i < mSigDBC5GeneSets.length; ++i){
					$('#selectMSigDBC5')
         				.append($("<option></option>")
         				.attr("value",mSigDBC5GeneSets[i])
         				.text(mSigDBC5GeneSets[i])); 
				} 				
			}
			
			function handleForm1Response(response) {				
				// Get unique geneset names
				if(!response) return;
				form1Response = response;
				if (form1Response.length==0){
					alert("None of your gene set names match those in the current database. The database is still in development. Please contact W.Wei@sheffield.ac.uk to help the development of the database.");
					return;
				}
				
				var u = {}, outputGenesetNames = [];
				for(var i = 0; i < form1Response.length; ++i){
					if(!u.hasOwnProperty(form1Response[i][0])) {
						outputGenesetNames.push(form1Response[i][0]);
						u[form1Response[i][0]] = 1;
					}
					if(!u.hasOwnProperty(form1Response[i][1])) {
						outputGenesetNames.push(form1Response[i][1]);
						u[form1Response[i][1]] = 1;
					}
				}
				
				var inputGeneSetNames = [];
				inputGeneSetNames = geneSetsValue.split("\n");
				
				var alertMessage =  " not match those in the current database:\n";
				var upperCaseOutputGenesetNames = [];
				for (var j = 0; j < outputGenesetNames.length; ++j){
					upperCaseOutputGenesetNames[j] = outputGenesetNames[j].toUpperCase();
				}
				var numberOfUnMatchedinputGenesets = 0;
				for ( var i = 0; i < inputGeneSetNames.length; ++i){
					var upperCaseInputGeneSetName = inputGeneSetNames[i].trim().toUpperCase();
					if (upperCaseOutputGenesetNames.indexOf(upperCaseInputGeneSetName) < 0) {
						alertMessage = alertMessage + inputGeneSetNames[i] + "\n"; 
						numberOfUnMatchedinputGenesets++;
					}
				}
					
				if (numberOfUnMatchedinputGenesets > 0) {
					var do_does = "do";
					if (numberOfUnMatchedinputGenesets ==1) {do_does = "does";}					
					alertMessage = numberOfUnMatchedinputGenesets + " of your gene set names " + do_does + alertMessage;
					alertMessage = alertMessage + "The database is still in development."
					alertMessage = alertMessage + "\nPlease contact W.Wei@sheffield.ac.uk to help the development of the database."
					alert(alertMessage);
					return;
				}
				$("#divInput").find('*').hide();
				$("#divResult").find('*').show();
				//alert(form1Response[0]);
				//alert(form1Response[0][0]);
				outputGenesetNames.sort();
				//alert("The geneset names are:" + outputGenesetNames);
				var partialCorrelationMatrix = [];
				for(var i = 0; i < outputGenesetNames.length; ++i){
					partialCorrelationMatrix[i] = [];
					for (var j = 0; j < outputGenesetNames.length; ++j){
						partialCorrelationMatrix[i][j] = 0;
					}
				}
				
				for(var k = 0; k < form1Response.length; ++k){
					var indexA, indexB;
					for (var i = 0; i < outputGenesetNames.length; ++i){
						if(form1Response[k][0] == outputGenesetNames[i]) {
							indexA = i;
						}
						if(form1Response[k][1] == outputGenesetNames[i]) {
							indexB = i;
						}
					}
					partialCorrelationMatrix[indexA][indexB] = form1Response[k][2];
					partialCorrelationMatrix[indexB][indexA] = form1Response[k][2];
				}

                sizeCanvas()
				
				var cnv4=document.getElementById('canvas1');
				var ctx4=cnv4.getContext('2d');
				ctx4.clearRect(0, 0, canvas1.width, canvas1.height);
				var clusterMethod = $("#selectClusterMethod").val();
				//alert("Clustermethod: " + clusterMethod);				
				var cx4 = new CanvasXpress('canvas1',
					{
						"z": { "gs" : outputGenesetNames},
						"x": { "gs" : outputGenesetNames},
						"y": {
							"vars": outputGenesetNames,
							"smps": outputGenesetNames,
							"data": partialCorrelationMatrix
						}
					}, 
					{
							"graphType": "Heatmap",
							"linkage" : clusterMethod,
							"varLabelRotate": 0,
							"maxSmpStringLen" : 20,
							"maxVarStringLen": 20,
							"autoScaleFont" : false,
							"varLabelFontSize" : 14,
							"smpLabelFontSize" : 14,
							"minTextSize" : 12,
							"title": "",
							"disableMenu" : true,
							"disableToolbar" : true,
							"resizable" : false
					},
					{
						'click' : function(o, e, t) {
							var eventDataId = t.getEventDataId(e);
							var selctedGeneSetName = "";
							if (eventDataId[0] && eventDataId[0].match(/Smp/)) {
								var A = eventDataId[0].split("-");
                                var H = parseInt(A[1]);
								selctedGeneSetName = t.data.y.smps[H];
							} else if (eventDataId[0] && eventDataId[0].match(/Var/)) {
								var A = eventDataId[0].split("-");
                                var H = parseInt(A[1]);
								selctedGeneSetName = t.data.y.vars[H];
							} else {
							}
							document.getElementById("selctedLeafName").innerHTML = selctedGeneSetName;
							var htmlLink = "";
							if (geneSetCollectionValue.match(/MSigDB/)) {
								htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + selctedGeneSetName +".html";
							} else if (geneSetCollectionValue.match(/pathprint/)) {
								//if (selctedGeneSetName.match(/KEGG/)){
								//	var linkGeneSetName = selctedGeneSetName.replace("(KEGG)", "");
								//	linkGeneSetName = linkGeneSetName.trim();
								//	var myRegExp = /\s|\W/g;
								//	linkGeneSetName = linkGeneSetName.replace(myRegExp, "_");
								//	linkGeneSetName = linkGeneSetName.toUpperCase();
								//	linkGeneSetName = "KEGG_" + linkGeneSetName + "_PATHWAY";
								//	htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + linkGeneSetName +".html";
								//} else {
									htmlLink = "http://compbio.sph.harvard.edu/hidelab/pathprint/Pathprint.html";
								//}
							}
							document.getElementById("selctedLeafNameLink").innerHTML = htmlLink;
							document.getElementById("selctedLeafNameLink").href = htmlLink;
							updateTable2(selctedGeneSetName);
						}
					}
				);
				if (clusterMethod != "DoNotCluster") {
					cx4.clusterSamples();
					cx4.clusterVariables();
				}
				
				//network
				var nodes = [];
				
				for(var i = 0; i < outputGenesetNames.length; ++i){
                    var newNode
					if($("#upgenesets").val() && (upGenesetNames.indexOf(outputGenesetNames[i].toUpperCase()) >= 0) ) {
                        // Member of the up-regulated geneset
						newNode = {"id": outputGenesetNames[i], "color" : "rgb(200,200,200)", "shape" : "sphere"};
					} else if($("#downgenesets").val() && (downGenesetNames.indexOf(outputGenesetNames[i].toUpperCase()) >=0) ) {
                        // Member of the down-regulated geneset
						newNode = {"id": outputGenesetNames[i], "color" : "rgb(55,55,55)", "shape" : "sphere"};
					}
					else {
						newNode = {"id": outputGenesetNames[i], "color" : "rgb(100,100,100)", "shape" : "sphere", "size": "0.5"};
					}
					nodes.push(newNode)
				}
				
				var tableData = new Array();
				var edges = new Array();
				var edgeIndex = 0;
				for(var k = 0; k < form1Response.length; ++k){
					var partialCor = form1Response[k][2];
					var pValue = form1Response[k][3];
					if (Math.abs(partialCor) > maxCorrInResponse) {maxCorrInResponse = Math.abs(partialCor);}
					if (pValue < minPValueInResponse) {minPValueInResponse = pValue;}
					if ( (Math.abs(partialCor) > corrCutOffValue) && (pValue < pCutOffValue) ) {
						tableData[edgeIndex] = form1Response[k];
						var lineWidth = Math.abs(10*partialCor) + 1;
						if (partialCor > 0) {
							edges[edgeIndex] = {"id1" : form1Response[k][0],
									"id2" : form1Response[k][1],
									"color" : "rgba(255,0,0, 0.3)",
									"type" : "line",
									"width" : lineWidth,
									"value": partialCor};
						} else {
							edges[edgeIndex] = {"id1" : form1Response[k][0],
									"id2" : form1Response[k][1],
									"color" : "rgba(0,0,255, 0.3)",
									"type" : "line",
									"width" : lineWidth,
									"value": partialCor};
						}
						edgeIndex++;
					}					
				}
				//console.log(nodes);
				//console.log(edges);
				
				$("#table1").show();
				var t = $('#table1').DataTable({
					destroy: true,
					"columnDefs": [
						{ className: "dt-body-left", "targets": [ 0 ] },
						{ className: "dt-body-left", "targets": [ 1 ] },
						{ className: "dt-body-right", "targets": [ 2 ] },
						{ className: "dt-body-right", "targets": [ 3 ] },
						{ className: "dt-body-right", "targets": [ 4 ] }
					],
					"dom": 'T<"clear">lfrtip',		
					"tableTools": {
						"sSwfPath": "/swf/copy_csv_xls_pdf.swf"
					}
				});
				t.clear();
				t.rows.add( tableData );
				t.draw();
				
				var cx2 = new CanvasXpress(
					"canvas2",
					{
						"nodes" : nodes,
						"edges" : edges
					},
					{	"backgroundGradient1Color": "rgb(255,255,255)",
						"backgroundGradient2Color": "rgb(255,255,255)",
						"gradient": true,
						"graphType": "Network",
						"nodeFontColor": "rgb(29,34,43)",
						"showAnimation": true,
						"disableMenu" : true,
						"disableToolbar" : true,
						"resizable" : false,
						"nodeFontSize" : 7
					},
					{
						'click' : function(o, e, t) {
							var eventDataId = t.getEventDataId(e);
							var selctedGeneSetName = t.data.nodes[eventDataId].id;
							document.getElementById("selctedLeafName").innerHTML = selctedGeneSetName;
							var htmlLink = "";
							if (geneSetCollectionValue.match(/MSigDB/)) {
								htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + selctedGeneSetName +".html";
							} else if (geneSetCollectionValue.match(/pathprint/)) {
								htmlLink = "http://compbio.sph.harvard.edu/hidelab/pathprint/Pathprint.html";
							}
							document.getElementById("selctedLeafNameLink").innerHTML = htmlLink;
							document.getElementById("selctedLeafNameLink").href = htmlLink;
							updateTable2(selctedGeneSetName);
						}
					}
				);
				
				var cnv=document.getElementById('canvas3');
				var ctx = cnv.getContext('2d');
				var pict = new Image();				
				if( topNValue > 0) {
					pict.src = "/pcxn/pcxn-legend1.png";
				} else {
					pict.src = "/pcxn/pcxn-legend2.png";
				}
				pict.onload = function (){
					ctx.clearRect(0, 0, canvas3.width, canvas3.height);
					ctx.drawImage(pict, 10, 10, pict.width*1, pict.height*1);
				}
			}

			function send(){
				var upVal = $("#upgenesets").val();
				var downVal = $("#downgenesets").val();
				var newTopNValue = $("#inputTopN").val();
				var newPCutOffValue = $("#inputpValue").val();
				var newCorrCutOffValue = $("#inputCorrelation").val();
				var newGeneSetCollectionValue = $("#selectGeneSetCollection").val();
				var newGeneSetsValue;

                // JSP API gets confused with leading and traling blank lines.
                // So eliminate those, and at the same time convert to upper case.
                upGenesetNames = upVal.trim().toUpperCase().split("\n")
                downGenesetNames = downVal.trim().toUpperCase().split("\n")
                $('#upgenesets').val(upGenesetNames.join("\n"))
                $('#downgenesets').val(downGenesetNames.join("\n"))

				if (upGenesetNames.length == 0 && downGenesetNames.length == 0)
				{
					alert("Please enter a list of gene sets!");
					return;
				}

                newGeneSetsValue = upGenesetNames.concat(downGenesetNames).join("\n").trim()

				if(((upGenesetNames.length + downGenesetNames.length)==1) && (newTopNValue==0)) {
					alert("Please specify the number of related gene sets to be found!");
					return;
				}

				if (newGeneSetsValue!=geneSetsValue |newTopNValue != topNValue | newPCutOffValue != pCutOffValue | newCorrCutOffValue != corrCutOffValue | newGeneSetCollectionValue != geneSetCollectionValue) {
					//alert("You have changed parameters!")
					geneSetsValue = newGeneSetsValue;
					topNValue = newTopNValue;					
					pCutOffValue = newPCutOffValue;
					corrCutOffValue = newCorrCutOffValue;
					geneSetCollectionValue = newGeneSetCollectionValue;
					$("#divResult").find('*').hide();
					var parms = {genesets : geneSetsValue, topN : topNValue , pCutOff : pCutOffValue, corrCutOff : corrCutOffValue, geneSetCollection :geneSetCollectionValue};
					$.getJSON("/pcxn/getPartialCorrelation.jsp", parms).done(handleForm1Response);
				} else {
					//alert("You have not changed parameters!")
					handleForm1Response(form1Response);
				}
			};
			
			function sendForm2(){
				$("#inputTopN").val($("#inputTopN2").val());
				$("#inputpValue").val($("#inputpValue2").val());				
				$("#inputCorrelation").val($("#inputCorrelation2").val());
				//alert($("#inputCorrelation").val());
				//return;		
				var val = $('input:radio[name=form2geneset]:checked').val();

				if(val =="radioPathprint") {
					$("#upgenesets").val($('#selectPathprint').val());
				} else if (val == "radioMSigDBC2CP") {
					$("#upgenesets").val($('#selectMSigDBC2CP').val());
				} else if (val== "radioMSigDBC5") {
					$("#upgenesets").val($('#selectMSigDBC5').val());
				} else {
					$("#upgenesets").val($('#textfieldGeneSet').val());
				}
				$("#downgenesets").val("") ;
				var newGeneSetsValue = $("#upgenesets").val();
				if(mSigDBC2CPGeneSets.indexOf(newGeneSetsValue) >=0) {
					$("#selectGeneSetCollection").val( "MSigDBC2CP");
				}
				else if(mSigDBC5GeneSets.indexOf(newGeneSetsValue) >=0) {
					$("#selectGeneSetCollection").val("MSigDBC5");
				}
				else if(pathprintGeneSets.indexOf(newGeneSetsValue) >=0) {
					$("#selectGeneSetCollection").val( "pathprint");
				}
				else {alert("Your gene set is not in the database");}
				javascript:send();
			};
			
			function updateTable2(geneSetNameValue) {
				$('#table2').hide();
				$("#table2waiting").show();
				//var geneSetNameValue = document.getElementById("selctedLeafName").innerHTML;
				var parms = {geneSetCollection : geneSetCollectionValue, geneSetName : geneSetNameValue};
				$.getJSON("/pcxn/getGeneSetMembers.jsp", parms).done(handleTable2Response);
			}
			
			function updateTable3() {
				$('#table3').hide();
				$("#table3waiting").show();
				var geneSetNameValue = document.getElementById("selctedNodeName").innerHTML;
				var parms = {geneSetCollection : geneSetCollectionValue, geneSetName : geneSetNameValue};
				$.getJSON("/pcxn/getGeneSetMembers.jsp", parms).done(handleTable3Response);
			}
			
			function handleTable2Response(response) {
				var tableData = response;
				var tableid = '#table2';
				updateGeneSetTable(tableid, tableData);
				$("#table2waiting").hide();
			}
			
			function handleTable3Response(response) {
				var tableData = response;
				var tableid = '#table3';
				updateGeneSetTable(tableid, tableData);
				$("#table3waiting").hide();
			}
			
			function updateGeneSetTable(tableid, tableData) {
				for(var k = 0; k < tableData.length; ++k){
					var entrezid = tableData[k][0];
					var htmlLink = "http://www.ncbi.nlm.nih.gov/gene/" + entrezid;
					var el = '<a target="_blank" href=' + htmlLink +">" + entrezid + "</a>";
					tableData[k][0] = el;				
				}
				var t = $(tableid).DataTable({
					destroy: true,
					"columnDefs": [
						{ className: "dt-body-right", "targets": [ 0 ] },
						{ className: "dt-body-left", "targets": [ 1 ] },
						{ className: "dt-body-right", "targets": [ 2 ] }
					],
					"dom": 'T<"clear">lfrtip',		
					"tableTools": {
						"sSwfPath": "/swf/copy_csv_xls_pdf.swf"
					}
				});
				t.clear();
				t.rows.add( tableData );
				t.draw();
			 	$(tableid).show();
			}
			
			function doneResizing() {
				//alert("I'm done resizing for the moment");
				handleForm1Response(form1Response);
			};
			
			function hideOpetionsAndResults() {			
				$("#divResult").find('*').hide();
				$("#label1").hide();
				$("#inputCorrelation2").hide();
				$("#label2").hide();
				$("#inputpValue2").hide();
				$("#button4").hide();
				$("#button3").hide();
			}
						
			var resizeTimer;
			$(window).resize(function() {
				clearTimeout(resizeTimer);
				resizeTimer = setTimeout(doneResizing, 100);
			});
		</script>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-8">
					<h1>Gene Set Coexpression Network</h1>
				</div>
				<div class="col-sm-4" id="menu">
					<ul>
						<li class="first"><a href="index.html" accesskey="1" title="">Home</a></li>
						<li><a href="news.html" accesskey="2" title="">News</a></li>
						<li><a href="about.html" accesskey="3" title="">About</a></li>						
						<li><a href="contacts.html" accesskey="4" title="">Contacts</a></li>			
					</ul>
				</div>
			</div>
			<div class="row" id="divInput">
				<div class="col-sm-6">
					<form id="form2" class="well">						
						<label for="inputTopN2">Find top</label>
						<input type="text" id="inputTopN2" value="10"/><label>gene sets</label><br>
						<label>Correlated with</label><br>						
						<input type="radio" id="radioMSigDBC2CP" name="form2geneset" value="radioMSigDBC2CP" checked>Select a gene set from MSigDB C2 CP (Canonical pathways)						    
						<br>
						<select id="selectMSigDBC2CP" size="1">
						</select><br>
						<input type="radio" id="radioMSigDBC5" name="form2geneset" value="radioMSigDBC5">Select a gene set from MSigDB C5 (GO gene sets)						    
						<br>
						<select id="selectMSigDBC5" size="1">
						</select><br>
						<input type="radio" id="radioPathprint" name="form2geneset" value="radioPathprint">Select a gene set from Pathprint						    
						<br>
						<select id="selectPathprint" size="1">
						</select>
						
						<br>
						<input type="radio" id="radioSearchGeneSet" name="form2geneset" value="searchGeneSet">Search a gene set 
						<input id="textfieldGeneSet" onkeypress="hideOpetionsAndResults()">																
						<br>																	
						<label id="label1" for="inputCorrelation2"> with absolute correlation coefficient greater than</label><br>
						<input type="text" id="inputCorrelation2" value="0.05"/><br>
						
						<label id="label2" for="inputpValue2">and p-value less than</label><br>
						<input type="text" id="inputpValue2" value="0.05"/><br><br> 
						
						<input type="reset" id="button4" value=" Reset "/>												
						<input type="button" id="button3" value=" GO " onclick="javascript:sendForm2();"/>
					</form>
					
					<form id="form1" class="well">
						<label for="upgenesets">Find partial correlation among gene sets up-regulated in phenotype 0</label><br>
						<textarea rows="7" cols="50" id="upgenesets"></textarea><br>
						
						<label for="downgenesets">and gene sets up-regulated in phenotype 1 </label><br>
						<textarea rows="7" cols="50" id="downgenesets"></textarea><br>
						
						<label for="inputTopN">and top</label>
						<input type="text" id="inputTopN" value="0"/><label>correlated genes sets</label><br>
						
						<label for="inputCorrelation"> with absolute correlation coefficient greater than</label>
						<input type="text" id="inputCorrelation" value="0.05"/><br>
						
						<label for="inputpValue">and p-value less than</label>
						<input type="text" id="inputpValue" value="0.05"/><br>
						
						<label for="selectGeneSetCollection">The gene sets are from</label>
						<select id="selectGeneSetCollection" size="1">
							<option value="pathprint">Pathprint</option>
						    <option value="MSigDBC2CP" selected="selected">MSigDB C2 CP (Canonical pathways)</option>
						    <option value="MSigDBC5">MSigDB C5 (GO gene sets)</option>
						</select>
						<br>
						<label for="selectClusterMethod">Cluster gene sets using</label><br>
						<select id="selectClusterMethod" size="1">
							<option value="average">Average linkage</option>
						    <option value="complete" selected="selected">Complete linkage</option>
						    <option value="single">Single linkage</option>
							<option value="DoNotCluster">Do not cluster</option>
						</select> 												
						<input type="reset" id="button2" value=" Reset "/>
						<input type="button" id="button1" value=" GO " onclick="javascript:send();"/>
					</form>
				</div>
				<div class="col-sm-6">
					<label><input type="radio" id="radioAnalysis1" name="radioAnalysis" value="radioAnalysis1" checked>Explore PCxN</label><br>
					<label><input type="radio" id="radioAnalysis2" name="radioAnalysis" value="radioAnalysis2">Analyze multiple gene sets identified by gene set enrichment analysis</label>
				</div>
			</div>
			<div id="divResult">
				<div class="row">
				<div class="col-sm-12">
                    <!-- The "box" class here is used to find the right DIV when resizing.
                         See sizeCanvas() -->
					<div class="col-sm-6 box">
						<h3>Partial Correlation Heatmap</h3>
                        <!-- This div gets replaced by sizeCanvas() -->
                        <div>
                            <canvas id="canvas1"></canvas>
                        </div>
					</div>
					<div class="col-sm-6 box">
						<h3>Partial Correlation Network</h3>
                        <div>
                            <canvas id="canvas2"></canvas>
                        </div>
					</div>
				</div>
			</div>
				<div class="row">
				<div class="col-sm-12">

					<div class="col-sm-6">	
						<h3>Gene set (click on a gene set name to select)</h3>
						<h3>Name</h3>
						<p id="selctedLeafName"> </p>
						<h3>External links</h3>
						<a id="selctedLeafNameLink" target="_blank" href=""></a>
						<h3>Members on HG-U133 Plus2 array</h3>
						<table id="table2" class="display" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th>GeneID</th>
									<th>Symbol</th>
									<th>Description</th>
								</tr>
							</thead>

							<tfoot>
								<tr>
									<th>GeneID</th>
									<th>Symbol</th>
									<th>Description</th>
								</tr>
							</tfoot>
						</table>
						<p id="table2waiting" class="waitmessage">Please wait. Getting data ....</p>
					</div>
					<div class="col-sm-6">
						<div class="span6">
                    		<label for="amount">Minimum absolute correlation coefficient:
                    		<input disabled=true size="3" type="text" id="coefficientText" style="border:0; margin-bottom:0; width: 50px" /></label>
                    		<input size="3" type="range" id="coefficientSlide" min="0.01" max="1" step="0.01"style="width: 350px"/>
                    		<div id="slider-edge" style="margin-botton: 5px"></div>
                    	</div>
                		<div class="span6">
                    		<label for="pvalueSlide">Maximum correlation p value:
                    		<input disabled=true size="3" type="text" id="pvalueText" style="border:0; margin-bottom:0; width: 50px" /></label>
                    		<input size="3" type="range" id="pvalueSlide" min="0.000001" max="0.05" step="0.001" style="width: 350px"/>
                    		<div id="slider-node"></div>
                		</div>
						<canvas id="canvas3" width="450" height="300"></canvas>
					</div>
				</div>
			</div>
				<div class="row">
				<div class="col-sm-12">
					<div class="col-sm-12">
						<h3>Partial Correlation Table</h3>
						<div class="col-sm-12">
							<table id="table1" class="display" cellspacing="0" width="100%">
								<thead>
									<tr>
										<th>Gene Set A</th>
										<th>Gene Set B</th>
										<th>Partial Correlation</th>
										<th>p Value</th>
										<th>Overlap Coefficient</th>
									</tr>
								</thead>

								<tfoot>
									<tr>
										<th>Gene Set A</th>
										<th>Gene Set B</th>
										<th>Partial Correlation</th>
										<th>p Value</th>
										<th>Overlap Coefficient</th>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>
				</div>
			</div>
			</div>
		</div>
	<script>
		function changeRadioSelection (e){
			//$('#radioSelectGeneSet').prop('checked', true);
			//alert(e.target.id);
			if(e.target.id =="selectPathprint") {
				document.getElementById("radioPathprint").checked = true;
			} else if(e.target.id =="selectMSigDBC2CP") {
				document.getElementById("radioMSigDBC2CP").checked = true;
			} else if(e.target.id =="selectMSigDBC5") {
				document.getElementById("radioMSigDBC5").checked = true;
			} else {}
			$("#label1").show();
			$("#inputCorrelation2").show();
			$("#label2").show();
			$("#inputpValue2").show();
			$("#button4").show();
			$("#button3").show();
		}
		function geneSetSearchCompleted (e, ui){
			$('#radioSearchGeneSet').prop('checked', true);
			showForm2LowerPart();
		}				
		$( "#textfieldGeneSet" ).on( "autocompleteselect", geneSetSearchCompleted);
		document.getElementById("selectPathprint").addEventListener("change", changeRadioSelection);
		document.getElementById("selectMSigDBC2CP").addEventListener("change", changeRadioSelection);
		document.getElementById("selectMSigDBC5").addEventListener("change", changeRadioSelection);	
		
		function radioAnalysisClick (e) {
			if (e.target.id == "radioAnalysis1") {
				$("#form1").hide();
				$("#divResult").find('*').hide();
				$("#form2").show();			
			} else if (e.target.id == "radioAnalysis2") {
				$("#form2").hide();
				$("#divResult").find('*').hide();
				$("#form1").show();	
			} else {
				alert("Error. Please contact W.Wei@sheffield.ac.uk");
			}
		}
		
		function form2RadioClick (e) {
			showForm2LowerPart();			
		}	
		
		function showForm2LowerPart () {
			$("#label1").show();
			$("#inputCorrelation2").show();
			$("#label2").show();
			$("#inputpValue2").show();
			$("#button4").show();
			$("#button3").show();
		}	
		document.getElementById("radioAnalysis1").addEventListener("click", radioAnalysisClick);
		document.getElementById("radioAnalysis2").addEventListener("click", radioAnalysisClick);
		document.getElementById("radioPathprint").addEventListener("click", form2RadioClick);
		document.getElementById("radioMSigDBC2CP").addEventListener("click", form2RadioClick);
		document.getElementById("radioMSigDBC5").addEventListener("click", form2RadioClick);
		document.getElementById("radioSearchGeneSet").addEventListener("click", form2RadioClick);
		
		function coefficientSlideChange (e) {		
			if ($("#coefficientSlide").val() > maxCorrInResponse) {
				alert("None of the edges in the network has absolute correlation coefficient > " + $("#coefficientSlide").val() ) ;
				return;
			}
			$("#inputCorrelation").val($("#coefficientSlide").val());
			javascript:send();			
		}
		
		function coefficientSlideInput (e) {
			$("#coefficientText").val($("#coefficientSlide").val());						
		}
		
		function pvalueSlideChange (e) {
			if ($("#pvalueSlide").val() < minPValueInResponse) {
				alert("None of the edges in the network has correlation p value < " + $("#pvalueSlide").val()) ;
			}
			$("#inputpValue").val($("#pvalueSlide").val());				
			javascript:send();			
		}
		
		function pvalueSlideInput (e) {
			$("#pvalueText").val($("#pvalueSlide").val());	
		}
		document.getElementById("coefficientSlide").addEventListener("change", coefficientSlideChange);
		document.getElementById("coefficientSlide").addEventListener("input", coefficientSlideInput);
		document.getElementById("pvalueSlide").addEventListener("change", pvalueSlideChange);
		document.getElementById("pvalueSlide").addEventListener("input", pvalueSlideInput);
	</script>
	</body>
</html>
